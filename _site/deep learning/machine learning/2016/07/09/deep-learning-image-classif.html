<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Réseau de neuronnes pré-entrainé appliqué à la classification d'images</title>
	
	<meta name="description" content="Utilisation d'un réseau de neuronnes déjà entrainé pour résoudre un problème de classification d'images différente de celle pour lequel le réseau de neuronnes a été entrainé.">
	
	<meta name="author" content="Antoine Vastel">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/antoinevastel">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/xopek59">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:antoine.vastel@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/42c0cef4d509eedea70a02b9a4276913?s=35" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://www.gravatar.com/avatar/42c0cef4d509eedea70a02b9a4276913?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header>


<div id="bio" class="text-center">
	French J2EE software engineer, passionnate about software engineering and machine learning!
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/antoinevastel">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/xopek59">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:antoine.vastel@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/antoinevastel">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Réseau de neuronnes pré-entrainé appliqué à la classification d'images </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   July 
	   9th,
	   
	   2016
	 </span>
	  <div class="article_body">
	  <p>Cet article présente comment utiliser un réseau de neuronnes déjà entrainé pour résoudre un problème de classification d’images (tâche différente que celle pour laquelle le réseau a été préalablement entrainé). Dans notre cas, notre objectif est de classer des images satellites de toits en 4 catégories : orientation EST/OUEST, orientation NORD/SUD, toit plat, et catégorie “Autre”. Il est important de préciser que cette tâche de classification est différente de celle pour laquelle le réseau de neuronnes que nous allons utiliser a été entrainé.</p>

<h2>Librairie MxNet</h2>
<p>La librairie de réseau de neuronnes que nous utiliserons se nomme MxNET. Elle est disponible à la fois sous Linux et Windows, et possède (entre autre) un wrapper en Python et en R. Dans cet article le code a été exécuté sous Ubuntu avec le wrapper Python.</p>

<h3>Installation de la librairie sous Ubuntu</h3>
<p>Tout d’abord, exécutez les commandes suivantes : </p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">sudo</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">update</span>
<span class="nx">sudo</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">y</span> <span class="nx">build</span><span class="o">-</span><span class="nx">essential</span> <span class="nx">git</span> <span class="nx">libatlas</span><span class="o">-</span><span class="nx">base</span><span class="o">-</span><span class="nx">dev</span> <span class="nx">libopencv</span><span class="o">-</span><span class="nx">dev</span></code></pre></div>

<p>Ensuite, clonez le dépot github de MxNet grâce à la commande ci-après :</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">git</span> <span class="nx">clone</span> <span class="o">--</span><span class="nx">recursive</span> <span class="nx">https</span><span class="err">:</span><span class="o">/</span><span class="sr">/</span><span class="err">github.com/dmlc/mxnet</span></code></pre></div>

<p>Puis pour compiler la librairie : </p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">cd</span> <span class="nx">mxnet</span><span class="p">;</span> <span class="nx">make</span> <span class="o">-</span><span class="nx">j$</span><span class="p">(</span><span class="nx">nproc</span><span class="p">)</span></code></pre></div>

<p>Si vous disposez d’un GPU assez récent et que vous avez déjà installé les librairies CUDA suffisantes, vous pouvez compiler la librairie avec la commande ci-dessous. Cela permettra à MxNet de tirer partie de votre GPU.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">cd</span> <span class="nx">mxnet</span><span class="p">;</span><span class="nx">make</span> <span class="o">-</span><span class="nx">j4</span> <span class="nx">USE_CUDA</span><span class="o">=</span><span class="mi">1</span></code></pre></div>

<p>Enfin, pour installer le package Python : </p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">cd</span> <span class="nx">python</span><span class="p">;</span> <span class="nx">sudo</span> <span class="nx">python</span> <span class="nx">setup</span><span class="p">.</span><span class="nx">py</span> <span class="nx">install</span></code></pre></div>

<p>En cas de problème lors de la phase d’installation, n’hésitez pas à consulter directement la <a href="http://myungjun-youn-demo.readthedocs.io/en/latest/how_to/build.html">documentation de MxNet.</a></p>

<h2>Extracteur de features</h2>
<p>Le réseau de neuronnes que nous allons utiliser se nomme Inception. Il a été entrainé sur le jeu de données Image Net et a une précision top-1 de 70% et top-5 de 89.9%.</p>

<p>Pour information, le jeu de données Image Net contient divers types d’images telles que des plantes, des animaux, des ustensiles etc… Sont but est de correctement prédire le type d’une image, ce qui est plutot différent (en apparence). Toutefois, ce réseau a appris à extraire des caractéristiques des images, afin de pouvoir les différencier les unes des autres. Il a appris, lors de sa phase d’apprentissage, à représenter les images sous une autre forme que le format brut dont on dispose.
Cela est similaire à une approche plus traditionnelle qui consiste à utiliser les HOGs (Histogramme de gradient orienté) ou aux SIFT (Scale-Invariant feature transform) pour entrainer un classifieur supervisé.</p>

<p>Pour chaque image nous allons donc extraire les caractéristiques générées par le réseau de neuronnes. Dans le cas du programme ci-après, nous avons les fichiers id_train.csv dans le répertoire courant (contient les ids et label des images de la phase d’entrainement), ainsi qu’un dossier roof_images contenant l’ensemble des images.</p>

<p>Le code ci-dessous extrait les features des images qui nous serviront à entrainer notre classifeur supervisé. Celles-ci sont écrites dans le fichier features_train.csv.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">mxnet</span> <span class="kn">as</span> <span class="nn">mx</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">transform</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>
<span class="kn">import</span> <span class="nn">Image</span>
<span class="kn">from</span> <span class="nn">skimage.util</span> <span class="kn">import</span> <span class="n">img_as_float</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>
<span class="kn">import</span> <span class="nn">skimage.io</span> <span class="kn">as</span> <span class="nn">i</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">directory</span> <span class="o">=</span> <span class="s">"./roof_images/"</span>

<span class="k">def</span> <span class="nf">PreprocessImage</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">show_img</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">mean_img</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c">#Chargement de l'image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">short_egde</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">short_egde</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">short_egde</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">crop_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">yy</span> <span class="p">:</span> <span class="n">yy</span> <span class="o">+</span> <span class="n">short_egde</span><span class="p">,</span> <span class="n">xx</span> <span class="p">:</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">short_egde</span><span class="p">]</span>
    <span class="c">#On redimensionne l'image a 224, 224</span>
    <span class="n">resized_img</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">crop_img</span><span class="p">,</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">show_img</span><span class="p">:</span>
        <span class="n">io</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resized_img</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">resized_img</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span>
    <span class="c">#On inverse les axes de l'image pour la transformer de (224, 224, 4) a (3, 224, 224)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c">#On soustrait la moyenne</span>
    <span class="n">normed_img</span> <span class="o">=</span> <span class="n">sample</span> <span class="o">-</span> <span class="n">mean_img</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">()</span>
    <span class="n">normed_img</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">normed_img</span>


<span class="k">def</span> <span class="nf">read_images</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"./id_train.csv"</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="c">#On charge le reseau pre entraine</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s">"Inception/Inception_BN"</span>
    <span class="n">num_round</span> <span class="o">=</span> <span class="mi">39</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">FeedForward</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">num_round</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">mx</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">numpy_batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c">#on charge l'image moyenne</span>
    <span class="n">mean_img</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">"Inception/mean_224.nd"</span><span class="p">)[</span><span class="s">"mean_img"</span><span class="p">]</span>
    <span class="n">synset</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s">'Inception/synset.txt'</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
    <span class="n">cpt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"./features_train.csv"</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">internals</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">get_internals</span><span class="p">()</span>
    <span class="n">fea_symbol</span> <span class="o">=</span> <span class="n">internals</span><span class="p">[</span><span class="s">"global_pool_output"</span><span class="p">]</span>
    <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">FeedForward</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">mx</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">symbol</span><span class="o">=</span><span class="n">fea_symbol</span><span class="p">,</span> <span class="n">numpy_batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">arg_params</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">arg_params</span><span class="p">,</span> <span class="n">aux_params</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">aux_params</span><span class="p">,</span>
                                 <span class="n">allow_extra_params</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#column0 = id image, colonne1= label, autres colonnes = features</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">imagePath</span> <span class="o">=</span> <span class="s">"./"</span><span class="o">+</span><span class="n">directory</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">"Id"</span><span class="p">])</span><span class="o">+</span><span class="s">".jpg"</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">PreprocessImage</span><span class="p">(</span><span class="n">imagePath</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">mean_img</span><span class="p">)</span>
        <span class="n">global_pooling_feature</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">"Id"</span><span class="p">])</span><span class="o">+</span><span class="s">","</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">"label"</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">","</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">global_pooling_feature</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">global_pooling_feature</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">","</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">global_pooling_feature</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">global_pooling_feature</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">cpt</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">read_images</span><span class="p">()</span></code></pre></div>

<p>Cette première phase nous a donc permis d’extraire un ensemble de caractéristique des images. Dans l’étape suivante nous utiliserons ces caractéristiques afin d’entrainer un classifieur supervisé. Nous explorerons plusieurs possibilités telles que kNN, random forest ainsi que la SVM.</p>

<h2>Entrainement du classifieur supervisé</h2>
<p>L’objectif désormais est d’entrainer un classifieur supervisé sur les caractéristiques que nous venons d’extraire dans l’étape précédente. Celui-ci aura pour rôle d’apprendre à classer correctement les images dans l’une des quatre catégories suivantes : </p>
<ul>
    <li>Toit orienté Est/Ouest</li>
    <li>Toit orienté Nord/Sud</li>
    <li>Toit plat</li>
    <li>Autre</li>
</ul>

<p>Notre programme permet de tester 3 solutions pour classer nos toits : kNN, random forest, SVM. Le programme ci-dessous est inspiré de celui que j’ai utilisé par la compétition Datascience Game. Grâce aux différents paramètres du début du programme on peut facilement changer le type de classifieur à utiliser (svm, kNN, random forest), le nombre de voisins dans le cas de l’algorithme kNN, ainsi le nombre d’images à utiliser pour entrainer notre classifieur.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>
<span class="kn">import</span> <span class="nn">skimage.io</span> <span class="kn">as</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">svm</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>

<span class="n">directory</span> <span class="o">=</span> <span class="s">"./roof_images/"</span>
<span class="n">n_neighbors</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">n_estimators</span> <span class="o">=</span> <span class="mi">32</span> <span class="c">#Pour random forest</span>
<span class="n">kernel_type</span> <span class="o">=</span> <span class="s">"linear"</span> <span class="c">#kernel a utiliser pour la svm</span>
<span class="c">#models : knn, randomforest, svm</span>
<span class="n">modelName</span> <span class="o">=</span> <span class="s">"svm"</span>
<span class="n">nbImagesTrainToRead</span> <span class="o">=</span> <span class="mi">6500</span>
<span class="n">nbImagesTestToRead</span> <span class="o">=</span> <span class="mi">1500</span>

<span class="c">#lit les features generees dans l'etape precedente</span>
<span class="k">def</span> <span class="nf">read_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">nbImagesToRead</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cpt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>
        <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cpt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">cpt</span><span class="o">%</span><span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">cpt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cpt</span> <span class="o">&gt;</span> <span class="n">nbImagesToRead</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">ids</span>

<span class="c">#entraine notre classifieur (knn, random forest ou svm)</span>
<span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">modelName</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Start training model"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modelName</span> <span class="o">==</span> <span class="s">"knn"</span><span class="p">:</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">knn</span>
    <span class="k">elif</span> <span class="n">modelName</span> <span class="o">==</span> <span class="s">"randomforest"</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="n">n_estimators</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>
    <span class="k">elif</span> <span class="n">modelName</span> <span class="o">==</span> <span class="s">"svm"</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel_type</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

<span class="c">#calcule la precision de notre classifieur</span>
<span class="k">def</span> <span class="nf">compute_accuracy</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">):</span>
    <span class="n">right</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">wrong</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Y_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">prediction</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">right</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wrong</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">right</span><span class="p">,</span> <span class="n">wrong</span>



<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">"./features_train.csv"</span><span class="p">)</span>

<span class="c">#on separe notre jeu de donnees en deux echantillons : un pour entrainer notre classifieur</span>
<span class="c">#le second pour tester la qualite de celui-ci</span>
<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">train_size</span> <span class="o">=</span> <span class="n">nbImagesTrainToRead</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="n">nbImagesTestToRead</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">read_features</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">nbImagesTrainToRead</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">read_features</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">nbImagesTestToRead</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    
<span class="n">model</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">modelName</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>

<span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">right</span><span class="p">,</span> <span class="n">wrong</span> <span class="o">=</span> <span class="n">compute_accuracy</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"right : "</span><span class="p">,</span><span class="n">right</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"wrong : "</span><span class="p">,</span><span class="n">wrong</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"accuracy : "</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">right</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">right</span><span class="o">+</span><span class="n">wrong</span><span class="p">))</span></code></pre></div>

<p>Le maximum de précision atteint en local est ~0.77 avec une svm utilisant un kernel rbf (radial basis function). Lors de l’évaluation sur Kaggle pour la compétition Datascience Game, le modèle a obtenu une précision de 0.73. Cela est globalement du au fait que notre jeu de données contient peu d’images de la catégorie “Autre” et que c’est une catégorie que nous avons du mal à prédire.</p>

<h3>Moral de l'histoire</h3>
<p>Nous partions plutot négatif pour cette compétition car de nos jours on associe souvent classification d’images avec deep learning. Or, il est très long de faire du deep learning sans carte graphique et/ou un bon processeur.</p>

<p>Il faut savoir que la génération des features avec le réseau de neuronnes a pris une 15ene d’heures sur un pc portable avec un processeur intel Celeron(ça existe encore en 2016 …), un disque dur classique (pas de ssd), et seulement 4GO de ram. L’entrainement du classifieur supervisé par la suite est très rapide ~1min, et est donc négligeable fasse au temps d’extraction des features.</p>

<p>Il est donc encore possible de nos jours de survivre dans les compétitions Kaggle ou de machine learning en général, même avec un pc légèrement (voir totalement) dépassé.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#deep learning-ref">
					deep learning <span>(1)</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#machine learning-ref">
					machine learning <span>(2)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#MxNet-ref">
					MxNet <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#Python-ref">
					Python <span>(2)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#Scikit learn-ref">
					Scikit learn <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#réseau de neuronnes-ref">
					réseau de neuronnes <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#classification images-ref">
					classification images <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Réseau de neuronnes pré-entrainé appliqué à la classification d'images&via=xopek59"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://www.gravatar.com/avatar/42c0cef4d509eedea70a02b9a4276913" class="img-rounded author-image" />
        <h4 class="section-title author-name">Antoine Vastel</h4>
        <p class="author-bio">French J2EE software engineer, passionnate about software engineering and machine learning!</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/algorithme/s%C3%A9ries%20temporelles/2016/06/05/prediction-fourier.html" title="Transformée de Fourier appliquée à la prédiction de séries temporelles">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2016 Antoine Vastel with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>
</body>
</html>



