<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Simulated annealing</title>
	
	<meta name="description" content="Presentation of simulated annealing technique applied to traveling salesman problem.">
	
	<meta name="author" content="Antoine Vastel">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/antoinevastel">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/xopek59">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:antoine.vastel@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/42c0cef4d509eedea70a02b9a4276913?s=35" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="http://www.gravatar.com/avatar/42c0cef4d509eedea70a02b9a4276913?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/"></a>
    </h3>
</header>


<div id="bio" class="text-center">
	French PhD student and engineer, passionnate about software engineering and machine learning!
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/antoinevastel">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/xopek59">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:antoine.vastel@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/antoinevastel">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Simulated annealing </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   January 
	   2nd,
	     
	   2017
	 </span>
	  <div class="article_body">
	  <p>Simulated annealing is an optimisation metaheuristic whose goal is to find the global minimum/maximum of a function in a large search space.
It is a random-search technique inspired from annealing in metallurgy, that’s why in this article you will see references to notions such as the energy or the temperature.</p>

<p>Compared to an optimisation technique such as gradient descent, you don’t need to compute any derivative of the function you want to optimize. Therefore, it can be applied to non-differentiable functions.
Moreover, it has less chance to get stuck in a local optima. The tradeoff for this feature is of course computational time.</p>

<p>In this article we’ll first present simulated annealing’s main concepts. Then, in a second time we’ll apply it to solve the traveling salesman problem.</p>

<h1 id="main-concepts">Main concepts</h1>

<p>If we do an analogy with physics, the goal of simulated annealing is to minimize the energy of a system. In an optimization problem it means minimizing a cost function.</p>

<p>To address this problem we start by defining two parameters:</p>

<ul>
  <li>The energy E, which is the value returned by the cost function you want to optimize;</li>
  <li>The temperature T, which we are going to explain the meaning later.</li>
</ul>

<p>We start from an initial solution S0 that can be generated randomly. We associate an energy E0 and a temperature T0 to this solution.</p>

<p>At each iteration, we generate a new solution Sn that slightly differs from the previous solution Sn-1. In the case of the traveling salesman problem that we are going to solve later, it consists in switching 2 cities in our solution.</p>

<p>Once we have generated a new solution, we can decide to accept or refuse it. The rules to take this decision are based on the Metropolis-Hastings algorithm.</p>

<p>We always accept a new solution that decreases the global energy of our system since it means that it is better than the previous one.</p>

<p>When En &gt; En-1 we don’t automatically reject it, even though it means that the new solution is worse than the previous one. We accept the new solution with a probability of <img style="margin-bottom: 21px" src="/assets/media/simu_ann_proba.svg" />.</p>

<h2 id="why-should-we-accept-a-worse-solution-">Why should we accept a worse solution ?</h2>
<p>You may wonder why we want to accept a solution that is worse than the previous one, which at first sight may seem unlogical.
The reason is to avoid local optima. Indeed, imagine on the picture below you start near point B. Then after few iterations you will converge to B. Since all of the new solutions will be worse, then you will get stuck in B, even though it is not the global minima. However, if you allow your algorithm to sometimes take “bad” decisions, it may enable you to leave B’s neighbourhood to go to A.</p>

<p><img style="margin:25px" src="/assets/media/Polynomialdeg4.png" /></p>

<h2 id="at-which-frequency-should-we-allow-bad-decisions">At which frequency should we allow “bad” decisions</h2>
<p>There are two parameters that influence this probability:
- The difference of energy ΔE between the two solutions;
- The temperature T of our system.</p>

<p>The only parameter we can influence is the temperature. The more we increase it, the more likely we are going to allow a solution that increases the global energy of our system. On the opposite, the smaller it is, the more likely we are going to refuse worse solutions.</p>

<p>Concerning the value to give to the temperature, it can set to a fixed value to the temperature or you can use a strategy that makes it vary over time. In the next part we will define a cooling rate parameter. After each iteration we will decrease our temperature by multiplying it with this rate.</p>

<p>The reason we do this is similar to the Boltzman selection in genetic algorithms. It tends to favor exploration at the begining, whereas in the end it focus on a local optima.</p>

<h2 id="algorithm">Algorithm</h2>
<p>To sum up, the general principle of the algorithm is to start from an initial solution. Then at each iteration we generate a slightly different solution. If it is better, then we automatically accept it. Otherwise we accept it with a probability of <img style="margin-bottom: 21px" src="/assets/media/simu_ann_proba.svg" />.</p>

<p>We repeat the iteration process until a stopping criterion is reached. It may be:
- A minimum value of the temperature;
- A number of iterations that has passed without acceptance of a new solution;
- A fixed number of iterations;</p>

<h1 id="traveling-salesman-problem">Traveling salesman problem</h1>

<p>In this part we apply simulated annealing to the traveling salesman problem. We already solved this problem in a <a href="/algorithme/python/algorithmes%20g%C3%A9n%C3%A9tiques/2016/04/30/probleme-voyageur-commerce.html">previous article</a> (in french) using genetic algorithms.</p>

<p>The problem is, given a set of cities, to find the shortest path to visit all of the cities exactly once.</p>

<p>We start by defining a City class.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">City</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">city</span><span class="p">):</span>
        <span class="n">distanceX</span> <span class="o">=</span> <span class="p">(</span><span class="n">city</span><span class="o">.</span><span class="n">lon</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="mi">40000</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">+</span> <span class="n">city</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">360</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span>
        <span class="n">distanceY</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">-</span> <span class="n">city</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="o">*</span> <span class="mi">40000</span> <span class="o">/</span> <span class="mi">360</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">distanceX</span> <span class="o">*</span> <span class="n">distanceX</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">distanceY</span> <span class="o">*</span> <span class="n">distanceY</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">distance</span></code></pre></figure>

<p>Then we define two classes: Tour and TourManager.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">TourManager</span><span class="p">:</span>
    <span class="n">destination_cities</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_city</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">city</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destination_cities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_city</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destination_cities</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">number_of_cities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destination_cities</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Tour</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tour_manager</span><span class="p">,</span> <span class="n">tour</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tour_manager</span> <span class="o">=</span> <span class="n">tour_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tour</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tour</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tour</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tour</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour_manager</span><span class="o">.</span><span class="n">number_of_cities</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">generate_individual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">indice_city</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour_manager</span><span class="o">.</span><span class="n">number_of_cities</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_city</span><span class="p">(</span><span class="n">indice_city</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour_manager</span><span class="o">.</span><span class="n">get_city</span><span class="p">(</span><span class="n">indice_city</span><span class="p">))</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_city</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tour_position</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="p">[</span><span class="n">tour_position</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_city</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tour_position</span><span class="p">,</span> <span class="n">city</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="p">[</span><span class="n">tour_position</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tour_distance</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">indice_city</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour_size</span><span class="p">()):</span>
                <span class="n">city_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_city</span><span class="p">(</span><span class="n">indice_city</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">indice_city</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour_size</span><span class="p">():</span>
                    <span class="n">city_arrival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_city</span><span class="p">(</span><span class="n">indice_city</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">city_arrival</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_city</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">tour_distance</span> <span class="o">+=</span> <span class="n">city_from</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">city_arrival</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">tour_distance</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span>

    <span class="k">def</span> <span class="nf">tour_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="p">)</span></code></pre></figure>

<p>Finally we create a SimulatedAnnealing class whose goal will be to run the simulated annealing algorithm. We need to pass the value of the initial temperature as well as the cooling rate to instantiate it.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">SimulatedAnnealing</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tour_manager</span><span class="p">,</span> <span class="n">initial_temperature</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tour_manager</span> <span class="o">=</span> <span class="n">tour_manager</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tour</span> <span class="o">=</span> <span class="n">Tour</span><span class="p">(</span><span class="n">tour_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="o">.</span><span class="n">generate_individual</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">initial_temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooling_rate</span> <span class="o">=</span> <span class="n">cooling_rate</span>

    <span class="k">def</span> <span class="nf">accept_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_energy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">delta_energy</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">delta_energy</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">evolve_tour</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tour_evolved</span> <span class="o">=</span> <span class="n">Tour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tour_manager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="p">)</span>

        <span class="n">pos1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="o">.</span><span class="n">tour_size</span><span class="p">())</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="o">.</span><span class="n">tour_size</span><span class="p">())</span>
        <span class="n">city1</span> <span class="o">=</span> <span class="n">tour_evolved</span><span class="o">.</span><span class="n">get_city</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>
        <span class="n">city2</span> <span class="o">=</span> <span class="n">tour_evolved</span><span class="o">.</span><span class="n">get_city</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>
        <span class="n">tour_evolved</span><span class="o">.</span><span class="n">set_city</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span> <span class="n">city1</span><span class="p">)</span>
        <span class="n">tour_evolved</span><span class="o">.</span><span class="n">set_city</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">city2</span><span class="p">)</span>

        <span class="n">current_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tour</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
        <span class="n">new_energy</span> <span class="o">=</span> <span class="n">tour_evolved</span><span class="o">.</span><span class="n">get_distance</span><span class="p">()</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">new_energy</span> <span class="o">-</span> <span class="n">current_energy</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept_solution</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tour</span> <span class="o">=</span> <span class="n">tour_evolved</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evolve_tour</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cooling_rate</span></code></pre></figure>

<p>We explain briefly the methods of this class:
The accept_solution method is responsible for deciding whether we want to accept a new solution or not. As we explained in the first part of this article, when the new solution is better than the previous one we always accept it. When that is not the case, we accept it with a probability of <img style="margin-bottom: 21px" src="/assets/media/simu_ann_proba.svg" />.</p>

<p>The evolve_tour method is an iteration of our simulated annealing algorithm. We generate a new solution by inverting the place of 2 cities randomly selected. We use the accept_solution method to decide whether or not we keep the new generated solution.</p>

<p>Finally, the run method is responsible for iterating while the temperature is greater than 1. After each iteration we multiply the temperature by 1 - cooling rate, which as we said previously, tends to favor exploration at the beginning.</p>

<p>We use the following main to run our algorithm. The cities of our example are the same french cities that we used for the genetic algorithm:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">tour_manager</span> <span class="o">=</span> <span class="n">TourManager</span><span class="p">()</span>
    <span class="n">city1</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">3.002556</span><span class="p">,</span> <span class="mf">45.846117</span><span class="p">,</span> <span class="s">'Clermont-Ferrand'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city1</span><span class="p">)</span>
    <span class="n">city2</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="o">-</span><span class="mf">0.644905</span><span class="p">,</span> <span class="mf">44.896839</span><span class="p">,</span> <span class="s">'Bordeaux'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city2</span><span class="p">)</span>
    <span class="n">city3</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="o">-</span><span class="mf">1.380989</span><span class="p">,</span> <span class="mf">43.470961</span><span class="p">,</span> <span class="s">'Bayonne'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city3</span><span class="p">)</span>
    <span class="n">city4</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">1.376579</span><span class="p">,</span> <span class="mf">43.662010</span><span class="p">,</span> <span class="s">'Toulouse'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city4</span><span class="p">)</span>
    <span class="n">city5</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">5.337151</span><span class="p">,</span> <span class="mf">43.327276</span><span class="p">,</span> <span class="s">'Marseille'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city5</span><span class="p">)</span>
    <span class="n">city6</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">7.265252</span><span class="p">,</span> <span class="mf">43.745404</span><span class="p">,</span> <span class="s">'Nice'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city6</span><span class="p">)</span>
    <span class="n">city7</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="o">-</span><span class="mf">1.650154</span><span class="p">,</span> <span class="mf">47.385427</span><span class="p">,</span> <span class="s">'Nantes'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city7</span><span class="p">)</span>
    <span class="n">city8</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="o">-</span><span class="mf">1.430427</span><span class="p">,</span> <span class="mf">48.197310</span><span class="p">,</span> <span class="s">'Rennes'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city8</span><span class="p">)</span>
    <span class="n">city9</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">2.414787</span><span class="p">,</span> <span class="mf">48.953260</span><span class="p">,</span> <span class="s">'Paris'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city9</span><span class="p">)</span>
    <span class="n">city10</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">3.090447</span><span class="p">,</span> <span class="mf">50.612962</span><span class="p">,</span> <span class="s">'Lille'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city10</span><span class="p">)</span>
    <span class="n">city11</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">5.013054</span><span class="p">,</span> <span class="mf">47.370547</span><span class="p">,</span> <span class="s">'Dijon'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city11</span><span class="p">)</span>
    <span class="n">city12</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">4.793327</span><span class="p">,</span> <span class="mf">44.990153</span><span class="p">,</span> <span class="s">'Valence'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city12</span><span class="p">)</span>
    <span class="n">city13</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">2.447746</span><span class="p">,</span> <span class="mf">44.966838</span><span class="p">,</span> <span class="s">'Aurillac'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city13</span><span class="p">)</span>
    <span class="n">city14</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">1.750115</span><span class="p">,</span> <span class="mf">47.980822</span><span class="p">,</span> <span class="s">'Orleans'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city14</span><span class="p">)</span>
    <span class="n">city15</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">4.134148</span><span class="p">,</span> <span class="mf">49.323421</span><span class="p">,</span> <span class="s">'Reims'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city15</span><span class="p">)</span>
    <span class="n">city16</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">7.506950</span><span class="p">,</span> <span class="mf">48.580332</span><span class="p">,</span> <span class="s">'Strasbourg'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city16</span><span class="p">)</span>
    <span class="n">city17</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">1.233757</span><span class="p">,</span> <span class="mf">45.865246</span><span class="p">,</span> <span class="s">'Limoges'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city17</span><span class="p">)</span>
    <span class="n">city18</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">4.047255</span><span class="p">,</span> <span class="mf">48.370925</span><span class="p">,</span> <span class="s">'Troyes'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city18</span><span class="p">)</span>
    <span class="n">city19</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="mf">0.103163</span><span class="p">,</span> <span class="mf">49.532415</span><span class="p">,</span> <span class="s">'Le Havre'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city19</span><span class="p">)</span>
    <span class="n">city20</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="o">-</span><span class="mf">1.495348</span><span class="p">,</span> <span class="mf">49.667704</span><span class="p">,</span> <span class="s">'Cherbourg'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city20</span><span class="p">)</span>
    <span class="n">city21</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="o">-</span><span class="mf">4.494615</span><span class="p">,</span> <span class="mf">48.447500</span><span class="p">,</span> <span class="s">'Brest'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city21</span><span class="p">)</span>
    <span class="n">city22</span> <span class="o">=</span> <span class="n">City</span><span class="p">(</span><span class="o">-</span><span class="mf">0.457140</span><span class="p">,</span> <span class="mf">46.373545</span><span class="p">,</span> <span class="s">'Niort'</span><span class="p">)</span>
    <span class="n">tour_manager</span><span class="o">.</span><span class="n">add_city</span><span class="p">(</span><span class="n">city22</span><span class="p">)</span>

    <span class="n">sa</span> <span class="o">=</span> <span class="n">SimulatedAnnealing</span><span class="p">(</span><span class="n">tour_manager</span><span class="p">,</span> <span class="n">initial_temperature</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">cooling_rate</span><span class="o">=</span><span class="mf">0.002</span><span class="p">)</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></code></pre></figure>

<p>By running the program we obtain a solution of 4615 km to visit all of our cities.</p>

<p>The graph below represents the distance in kilometers against the number of iterations. As we can see, it is quite chaotic at the beginning and tends to stabilize in the end, when the temperature decreases.</p>

<p><img src="/assets/media/converge_sim_ann.png" /></p>

<p>If we compare it with the graph below obtained by running a genetic algorithm, we can see the difference in the way the two algorithms converges.</p>

<p><img src="/assets/media/evol_distance_tsp.png" /></p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#Machine learning-ref">
					Machine learning <span>(3)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#Python-ref">
					Python <span>(5)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#Scikit learn-ref">
					Scikit learn <span>(3)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#pandas-ref">
					pandas <span>(2)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Simulated annealing&via=xopek59"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="http://www.gravatar.com/avatar/42c0cef4d509eedea70a02b9a4276913" class="img-rounded author-image" />
        <h4 class="section-title author-name">Antoine Vastel</h4>
        <p class="author-bio">French PhD student and engineer, passionnate about software engineering and machine learning!</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/network%20performance/2016/11/09/automatic-chrome-network-timeline.html" title="Automatic Chrome network timeline">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2017 Antoine Vastel with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>
</body>
</html>



